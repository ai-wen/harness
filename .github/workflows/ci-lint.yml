name: CI Linter pipeline
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  GIT_COMMIT: ${{ github.sha }}
  GITNESS_VERSION_MAJOR: "3"
  GITNESS_VERSION_MINOR: "3"
  GITNESS_VERSION_PATCH: "0"
  BUILD_VERSION: "v3.3.0"

jobs:
  # web:
  #   name: CI linter for js/ts
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #         cache: "npm"
  #         cache-dependency-path: web/yarn.lock
  #     - name: install, lint, and build web app
  #       working-directory: web
  #       run: |
  #         yarn install
  #         yarn check:all
  #         yarn build
      
  #     - name: Upload web build artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: web-build
  #         path: web/dist/
  #         retention-days: 7
  
  build-windows:
    name: Build for Windows 7
    runs-on: ubuntu-latest
    #needs: [web] 
    env:
      TARGETOS: windows
      TARGETARCH: amd64
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
  
      - uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Get Git commit info
        id: git-info
        run: |
          echo "GIT_COMMIT_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT_FULL=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "GIT_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')" >> $GITHUB_OUTPUT
      
      - name: Setup mingw-w64 for Windows cross-compilation
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64
          x86_64-w64-mingw32-gcc --version
      
      - name: Build Windows 7 compatible executable
        env:
          CC: x86_64-w64-mingw32-gcc
          LDFLAGS: "-extldflags '-static -Wl,--major-subsystem-version=6,--minor-subsystem-version=1'"
        run: |
          mkdir -p ./dist ./release
          
          echo "Building for Windows 7 (Windows 6.1) compatibility..."
          
          CGO_ENABLED=1 \
          GOOS=windows \
          GOARCH=amd64 \
          CC=$CC \
          go build \
            -ldflags="$LDFLAGS" \
            -tags="netgo osusergo" \
            -o ./dist/gitness-windows-amd64.exe \
            ./cmd/gitness
          
          file ./dist/gitness-windows-amd64.exe
          
      - name: Upload complete Windows 7 package
        uses: actions/upload-artifact@v4
        with:
          name: gitness-windows7-complete
          path: ./dist/
          retention-days: 7
          if-no-files-found: error
